## 이더리움 토막상식(1-1)

1. 이더리움 ICO는 언제?  
2014년 7월 22일부터 9월 2일까지 모금되었으며, 초기가격은 약 $0.31 하지만 달러를 직접 받지 않았고 1 BTC로 2000개의 ETH를 구매할 수 있었다(교환 비율은 조금씩 변경됨).


2. 이더리움 네트워크의 첫 론칭은?
2015년 7월 30일 "Frontier"를 시작으로 이더리움 네트워크가 공개. 이후 이더리움은 수년간에 걸쳐 하드포크를 통해 업그레이드 되었다. 현재까지 이루어진 이더리움 하드포크 히스토리와 정보는 아래 링크를 참조.  
[Ethereum Execution Client Specifications](https://github.com/ethereum/execution-specs)


3. `chainId` 와 `networkId` 의 차이  
2016년 "The DAO"라는 프로젝트가 시작되었는데, The DAO는 이더리움에서 구현된 크라우드 펀드였다. 그런데 펀드가 예치된 스마트 컨트랙트가 해킹되어 약 6천만 달러의 이더가 탈취된 사건이 발생. 이것을 수습하는 과정에서 이더리움 커뮤니티가 분열되었고 한쪽은 해킹 이전으로 하드포크, 한쪽은 그대로 유지하자는 의견으로 갈라졌고 결국 그대로 유지하자는 쪽이 이더리움 클래식(ETC)을 만들게 되었다.  
사실상 동일한 네트워크가 두 개가 생긴 상황이 되어버렸는데, 이렇게 되면 한쪽 네트워크에서 만들어진 트랜잭션을 다른 쪽 네트워크에서 그대로 실행할 수 있는 "replay attack"이 가능해졌다.  
replay attack을 막기 위해 EIP-155가 제안되었고 트랜잭션에 체인 정보인 `chindId`를 추가하도록 수정. 기존에 이미 존재했던 `networkId`는 이더리움이나 이더리움 클래식이나 1로 동일하지만 `chainId`는 이더리움이 1, 이더리움 클래식이 61로 정해지게 되었다.


4. `chainId`와 전자서명  
이더리움 트랜잭션의 전자서명(r,s,v)에서 마지막 한 바이트(v)는 처음 32바이트(r)가 짝수일 때 27(0x1b), 홀수일 때 28(0x1c)이었는데 EIP-155 이후 트랜잭션에 `chainId`가 포함되면서 전자서명의 마지막 한 바이트(v)를 `chainId`를 사용하여 계산된 값이 들어가도록 변경되었다.  
즉 r 값에 따라서, 이더리움 메인넷(chainId=1)의 경우  
r이 짝수일 때: v = 0 + chainId\*2 + 35 = 0 + 1\*2 + 35 = 37(0x25)  
r이 홀수일 때: v = 1 + chainId\*2 + 35 = 1 + 1\*2 + 35 = 38(0x26)  
이더스캔에서 RLP인코딩된 raw 트랜잭션으로 v 값의 변화를 알 수 있다.
2016-7-20  
Tx hash=`0xfb00335dde25fbdee3650ea54d1985a202061629cc2a76a4f846d090813634e2`, chainId=0, v=27  
2023-9-23(현재)  
Tx hash=`0x88d02d54935831bd9bd04c264ba0d4055bb2b6ccbe0b781f75bc8d3acd871d29`, chainId=1, v=38  

   ```
   ethers.utils.parseTransaction("0xf86d8085037e11d6008303d0909452e86988bd07447c596e9b0c7765f8500113104c8803bd37b692e2a4008026a065cbe8a99d2d98626b5e4fab89e0626ac14f79bb985b9b094af29d3b3de91094a015af31b692cb72549b0b55309282a0baab7e1e559c0ad60d5bdd8615d94eb9bc")
   {"nonce":0,"gasPrice":{"type":"BigNumber","hex":"0x037e11d600"},"gasLimit":{"type":"BigNumber","hex":"0x03d090"},"to":"0x52E86988bd07447C596e9B0C7765F8500113104c","value":{"type":"BigNumber","hex":"0x03bd37b692e2a400"},"data":"0x","chainId":1,"v":38,"r":"0x65cbe8a99d2d98626b5e4fab89e0626ac14f79bb985b9b094af29d3b3de91094","s":"0x15af31b692cb72549b0b55309282a0baab7e1e559c0ad60d5bdd8615d94eb9bc","from":"0xf6A25E53D69e1fD982BEd5e48820907bFf627751","hash":"0x88d02d54935831bd9bd04c264ba0d4055bb2b6ccbe0b781f75bc8d3acd871d29","type":null} 
   ```


5. 이더리움 하드포크 이름은 어떻게 정해지나?  
이더리움 하드포크 이름은 전통적으로 (현재 또는 과거의) 도시 이름을 따라 명명되었다. 지분증명 전환 후에는 합의계층(Consensus Layer, CL)과 실행계층(Execution Layer, EL)의 하드포크 이름을 각각 정하게 되었고 실행계층은 그대로 도시 이름을 사용하고 합의 계층은 별 이름을 따서 정하는 것이 관례.  
CL 하드포크 - Altair, Bellatrix, Capella  
EL 하드포크 - Berlin, London, Paris, Shanghai  
CL과 EL이 동시에 하드포크 되는 경향이 있으므로 둘을 붙여서 부르기도 한다. 예를 들어 Capella+Shanghai=Shapella


6. geth의 `genesis.json`에 256개의 계정들이 1 wei 잔액을 가지는 이유?  
geth 개발자 Péter Szilágyi의 설명에 의하면 이 계정들(0x00..00-0x00..FF)은 precompiled 컨트랙트를 위한 계정으로, EVM 연산이 복잡해서 비용(가스)이 많이 드는 연산들을 컨트랙트로 미리 만들어 놓은 것이라고 한다. 일종의 EVM의 빌트인 함수인 셈. 예를 들어 솔리디티 `ecrecover` 함수를 사용하면 0x00...04를 호출하게 되는 식.
잔액이 1 wei인 이유는 EIP-161 "State trie clearing"이 적용되었기 때문인데, 2016년 9월에 발생한 DoS 공격(일명 Shanghai attack)이 원인이 되었다. 이 공격은 해커가 천만개 이상의 빈(empty) 계정을 저렴하게(?) 만들면서 이더리움의 상태 트리를 커지게 해서 노드의 디스크 I/O 부하를 가중시키게 되었다.  
해커가 만든 빈 계정을 삭제하기 위해 EIP-161을 적용되었는데, 코드가 없고, nonce가 0이면서 잔액도 0인 계정은 삭제하는 것이다. 따라서 precompiled 계정이 "clearing" 되지 않게 하기 위해서는 1 wei 잔액이 필요하게 되었다.


7. 이더리움의 지분증명은 언제 시작되었나?  
이더리움의 지분증명 비콘체인은 2020년 12월 1일부터 시작되었다. 당시 작업증명으로 동작하는 이더리움은 여전히 동작하고 있었기 때문에 사실상 두 개의 독립적인 이더리움 체인이 병행해서 존재했다고 볼 수 있다. 하지만 비콘체인은 트랜잭션을 처리하는 체인이 아니고 합의를 위한 메시지들을 저장하는 용도였고 보상으로 발행되는 이더는 인출되지 않았다.  
2022년 9월 15일 "The Merge"(Bellatrix 하드포크)가 성공하면서 드디어 작업증명 체인이 지분증명 체인에 통합되면서 작업증명은 역사 속으로 사라지게 되었다. 작업증명 체인은 이제 실행계층(Execution Layer, EL)이라는 이름으로 변경되었고, 실행계층의 블록을 생성하는 주체는 "채굴자"에서 "검증자"로 넘어갔다. 이제 막대한 해시파워가 필요없게 된 것이다.  
The Merge 이후에도 비콘체인에서 발생하는 검증보상은 인출되지 않았지만 2023년 4월 Shapella 하드포크부터 비로소 인출이 가능하게 되었다.


8. 검증보상 인출과 트랜잭션 수수료  
지분증명으로 통합된 이후 과거 채굴자들이 채굴보상으로 받던 블록보상(당시 2Ξ)은 없어지고 다만 트랜잭션 수수료가 비콘 블록 생성자들에게 돌아갔다. 이 수수료는 실행계층의 지정된 fee recipient 계정으로 인출된다. 반면 검증보상은 Shapella 하드포크 이후에 인출이 가능해졌는데, 최대 유효잔액 32Ξ를 넘는 경우에 32Ξ를 제외한 나머지가 지정된 "withdrawal" 계정으로 자동 인출된다. 수수료 계정과는 다르게 한번 지정되면 변경할 수 없다. 인출은 검증자 순번대로 차례로 실행되며 보통 한 블록당 최대 16건의 인출이 이루어진다. 수취 계정이 부담하는 가스비는 없다. `eth_getBlockByHash`와 같은 RPC 호출로 인출 내역을 조회할 수 있다.
   ```
    "withdrawals": [
            {
                "address": "0x3eb45247074ea57b0bf1841e0976f0850dc5011e",
                "amount": "0xf5efa6",
                "index": "0x11b8451",
                "validatorIndex": "0xc786f"
            },
            {
                "address": "0x3eb45247074ea57b0bf1841e0976f0850dc5011e",
                "amount": "0xf63f7b",
                "index": "0x11b8452",
                "validatorIndex": "0xc7870"
            },
   ```
   검증자가 되기 위해 처음 예치한 32개를 포함한 전액을 인출하기 위해서는 검증자 풀에서 완전히 빠져나와야 한다. 


9. 지분증명 전환(The Merge) 이후 블록해시는 어떻게 되었나?  
작업증명 방식에서는 Ethash 알고리즘에 의해 nonce를 찾고 블록헤더를 해시하여 블록해시를 만들었다. 다른 사람들보다 먼저 블록해시를 만들기 위해서는 많은 해시파워가 필요했고 또 해당 블록이 정상적으로 만들어졌는지 확인하는 중요한 값이었으나 지분증명 이후에는 이러한 중요성이 사라지게 되었다.  
nonce는 `0x0000000000000000`으로 고정되었고 mixHash가 비콘체인에서 생성되는 pseudorandomn 값으로 대체되었다. 지분증명 전환 후 블록헤더에서 달라지는 것들은 아래 링크를 참조.  
[How The Merge Impacts Ethereum’s Application Layer](https://blog.ethereum.org/2021/11/29/how-the-merge-impacts-app-layer)


10. 지분증명의 "Weak Subjectivity"  
블록체인은 불특정 다수가 참여해서 약속된 프로토콜이 구현된 노드를 각자 실행하여 스스로 "원장"을 만들어간다. 즉 코드화된 프로토콜에 기반한 합의방식에 따라 데이터를 생성하는 것이므로 상호 신뢰 없이(trustless) 동일한 거래 데이터를 가질 수 있게 되는 것.  
비트코인은 작업증명에 따라 누구나 제네시스 블록부터 현재 블록까지 블록체인을 재생성할 수 있다. 이것을 합의방식의 "객관성(Objectivity)"이라고 말한다. 반대로 지분증명은 "주관성(Subjectivity)"의 특성이 있다고 말하는데 이것은 누구나 블록을 만드는 것이 아니라 "지분"이라는 자격 조건이 있고 또 "투표(vote, attestation)"에 의해 합의하므로 나중에 네트워크에 참여하는 노드들은 먼저 참여한 노드들의 "투표"에 대한 신뢰 여부를 (주관적으로) 판단해야 하는 상황에 놓이게 된다. 물론 프로토콜에 따라 투표하는 것이기는 하지만 33% 이상의 참여자들이 다른 마음을 먹는다면 얼마든지 확정되지 않은 분기 체인들이 나타날 수 있고 그들 중에 누가 canonical인지 명확하지 않다.  
이더리움의 경우 분기를 의도적으로 만들면 "슬래시(slash)"되지만 검증자 풀에서 제외될 때까지 시간이 소요되므로 이 시간동안 새로운 노드가 참여하는 경우 잘못된 분기 체인을 싱크할 가능성이 존재한다. 33%의 검증자가 빠져나가기 전 상태의 "구간"에 있다면(weak subjectivity period) 다른 경로로 검증할 방법을 찾아야 한다. 즉 주관성의 개입을 "최소화(weak)" 할 필요가 생긴다.  

    이더리움 지분증명에서는 "weak subjectivity checkpoints"라는 것으로 주관성을 약화시킨다. 이것은 모든 노드들이 합의하는 "체크포인트"이라고 볼 수 있는데 마치 제네시스 블록과 같은 역할을 하므로 새로운 노드가 네트워크에 참여하여 싱크할 때 시작점으로 사용할 수 있다. weak subjectivity checkpoint는 이더스캔과 같은 다수의 공용 블록 탐색기로부터 그 체크포인트가 유효한 것인지 확인할 수 있다.  
[Beacon Chain checkpoint sync endpoints](https://eth-clients.github.io/checkpoint-sync-endpoints/)  
비콘체인 클라이언트 프리즘의 경우는 싱크할 때 weak subjectivity checkpoint를 이용하는 옵션을 제공한다.  
[Sync from a checkpoint](https://docs.prylabs.network/docs/prysm-usage/checkpoint-sync#verify-the-authenticity-of-your-beacon-nodes-checkpoint)


11. 비콘체인 합의 방식  
이더리움의 비콘체인은 크게 두 가지 프로토콜에 의해 데이터에 합의한다. 블록체인의 가장 최근 블록을 결정하는 LMD-GHOST와 epoch(약 6.4분) 마다 지분을 예치한 검증자들 66% 이상(supermajority)이 justified-finalized로 데이터를 확정해나가는 Casper FFG를 통해 체인을 만들어간다.  
fork choice rule에 해당하는 LMD-GHOST는 소위 말하는 "Liveness"와 관련이 있다. 블록을 생성하는 검증자는 LMD-GHOST에 의해 하나의 체인을 결정하고 이어나간다. 이것은 비콘 체인에서 발생하는 메시지들(attestation)은 결국 블록에 저장될 수 있다는 것을 의미한다. 그래서 Liveness를 "Something good eventually happens"라고 표현한다.  
FFG는 "Safety"와 관련이 있다. 블록체인에 기록된 데이터들은 프로토콜을 준수하는 대다수의 검증자(supermajority)들에 의해 2단계(justified-finalized)에 걸쳐 확정되므로 나중에 삭제되거나 변경되는 "나쁜 일(bad things)"은 일어나지 않는다. Safety는 "Bad things do not happen"이라고 표현한다.
이 두 개의 프로토콜을 합쳐서 "Gasper"라고 부르기도 한다.  

    모든 검증자들은 12초 단위로 32개의 슬롯에 배치되어 해당 슬롯에서 만들어지는 블록을 검증해야 한다. 32개의 슬롯이 1 epoch이 되므로 6.4분 마다 검증을 수행해야 하는 것이다. 또 각 슬롯마다 블록 생성자가 슈도랜덤하게 선택되므로 6.4분마다 32개의 검증자가 블록 생성자가 된다. 지분증명 전환 후에는 실행계층의 블록(블록이라기 보다는 비콘 블록에 포함된 payload 형태)도 같이 검증하는데 작업증명이 했던 검증을 제외한 나머지 유효성 검사를 수행한다.


12. 블록과 슬롯의 차이점  
작업증명에서는 블록이 생성되지 않는 경우가 없었다. 지분증명으로 전환된 이후에는 작업증명에서 만들던 트랜잭션 처리 블록은 비콘체인의 블록 안에 payload 형태로 들어가게 되는데, 비콘체인에서는 슬롯에서 선택된 검증자가 비콘 블록을 생성하지 않을 수도 있으므로 이렇게 되면 그 시점에 처리되어야 할 트랜잭션은 다음 슬롯의 블록에 저장될 수 밖에 없다.  
따라서 작업증명에서는 블록주기, 즉 트랜잭션 처리 주기가 대략 10-15초 내외였다고 한다면 지분증명 전환 후에는, 정상적이라면 12초가 되고 블록 생성자가 블록을 만들지 않으면(skip, missed) 24초 이상이 될 수도 있다.  
예를 들어 슬롯번호 6794371은 비콘블록이 생성되지 않았고 당연히 실행계층 payload도 처리되지 않는다. 하지만 6794372 슬롯에서는 정상적으로 블록이 생성되고 밀린 트랜잭션들이 처리된다. 실행계층의 블록번호는 빠짐없이 일련번호로 이어진다. 따라서 과거 블록 "높이"라고 하던 블록번호의 차이는 의미가 없다. 중간에 skip 블록이 있는 경우는 블록번호의 차이가 1이라고 해도 실제 간격이 더 클 수 있기 때문이다.  


13. attestation이 하나도 저장되지 않은 비콘블록  
작업증명에서도 더 빨리 블록을 만들기 위해 트랜잭션을 하나도 저장하지 않는 채굴자들이 있긴 있었다.  
[12987627](https://etherscan.io/block/12987627)  
비콘체인에서 블록 생성자는 이전에 발생된 attestation 메시지들을 모아서 블록을 생성한다. 만약 attestation을 저장하지 않는다면 프로토콜 위반일까? 그렇지는 않다. 왜냐하면 여러 이유로 attestation을 받지 못할 수도 있기 때문이다. 예를 들어 슬롯번호 30998에서 생성된 블록은 attestation이 하나도 없다.  
[30998](https://beaconcha.in/slot/30998)   
attestation을 얼마나 많이 저장했는지에 따라 블록 생성 보상이 늘어나기 때문에 하나도 저장하지 않는 것은 손해라고 볼 수 있다.


14. 이더리움 생태계의 보상 구조  
작업증명에서는 블록을 생성하는 채굴자에게 보상이 집중되어 있었다. 트랜잭션의 순서를 조정하여 추가적인 이익을 얻는 MEV(Maximal Extractable Value)가 유행하면서 채굴자들에게 MEV를 획득할 수 있는 트랜잭션 번들을 의뢰하는 사람들 "Searcher"들이 나타났고, 이를 처리하기 위해 플래시봇 개발팀이 만든 MEV-geth를 도입하는 채굴자들이 늘어났다(해시파워의 반 이상을 차지하는 채굴자들이 MEV-geth를 채택). 이들 트랜잭션들은 "mempool"이라고 하는 일반적인 트랜잭션 공용 풀에 들어가지 않으므로 채굴되서 블록 탐색기에 나타나기 전에는 알기 힘든 측면이 있다.  
지분증명 전환 후에는 채굴자들이 검증자들로 바뀌었고 MEV-geth는 MEV-boost로 대체되었다. 더구나 블록 자체를 검증노드가 직접 만드는 것이 아니라 "블록 빌더"라는 외부 참여자들이 Searcher가 의뢰한 트랜잭션들을 "MEV 블록"으로 만들어서 검증노드에 릴레이하면 검증노드는 다수의 블록 빌더가 보낸 블록들 중 가장 이익이 높은(most profitable block) 블록을 선택하는 방식이 되었다.  
MEV-geth와 마찬가지로 검증노드들의 MEV-boost의 채택 비율은 거의 80-90%에 이르기 때문에 이더리움의 장기 로드맵 중 하나인 "PBS(Proposer-Builder Separation)"은 이미 실행 중이라고 볼 수도 있다. 다만 이더리움 밖에서 이루어지기 때문에 트랜잭션 검열 등의 문제가 제기되기도 한다.  
결과적으로 이더리움 생태계에서 발생하는 수익들은 대략 아래와 같이 정리할 수 있다:  

    - 블록 보상(검증보상+트랜잭션 수수료+MEV블록보상) ⇒ Validator(Proposer)
    - MEV 블록 생성 및 릴레이 수수료 ⇒ Block builder, Relayer
    - MEV 수익 ⇒ Searcher 

    검증자는 블록 빌더로부터 MEV블록을 받아서 어느 정도의 부가적인 수익을 얻을 수 있을까? 운이 좋으면 [337Ξ를 받은 검증자](https://beaconcha.in/block/15802413)가 나올 수도 있다. 
    현재 많은 블록 빌더와 릴레이가 존재한다. 대략적인 통계는 아래 사이트를 참조.  
    [rated](https://www.rated.network)  
    앞으로 진행될 샤딩 관련 하드포크(EIP-4844)까지 고려하면, 소위 말하는 롤업 데이터 공간 "Blobspace"에 대한 보상도 추가될 수 있다. Blobspace에 대한 수수료는 트랜잭션과는 다른 수수료 체계가 적용될 예정이다.


15. 검증자의 보상 구조  
비콘체인의 검증자들은 위에서 말한 것처럼 블록을 생성하거나(MEV-boost를 사용하면 사실상 서명만 한다) 검증하면서 새로 발행되는 이더를 받는다. 검증 보상의 연간 수익률은 대략 3-4% 정도로 추산한다.  
보상은 예치된 이더 수량이 늘어날 수록 줄어드는 구조이다. 또 검증자 자신의 유효잔액(effective balance)으로 계산되므로 검증자마다 차이가 날 수 있다. 전파한 attestation이 얼마나 빨리 블록에 저장되는지도 보상에 영향을 준다(이것을 "inclusion distance"라고 표현한다). 보통은 다음 슬롯에서 생성되는 블록에 저장되지만 지연될수록 보상이 줄어든다.  
검증자의 의무를 수행하지 않는 경우에는 받아야 할 보상만큼을 차감해서 벌금을 부과한다. 이것은 32개를 예치하고 정상적인 검증자의 의무를 다하지 않으면 자신에게 불이익이라는 것을 의미한다. 하지만 이러한 "inactivity leak"는 프로토콜 위반이 아니므로 슬래싱과 구별되고 그렇게 큰 손해는 아니다. 선택된 블록 생성자가 블록을 생성하지 않는 경우는 차감하지 않는다.  
부가적인 보상도 있다. Sync committee로 선출되면 약 하루동안(256 epoch) 보상을 받게 되므로 일일 누적 보상이 늘어난다. Sync committee는 하루에 512개의 검증자가 선출된다. 또 프로토콜 위반자를 적발하는 "슬래셔"를 운영해서 실제로 위반을 발견하고 보고하는 경우("whistleblower"라고 한다)에도 정해진 보상을 지급한다.  


16. ultra-sound money  
초음파 화폐? 여기서는 가치가 매우 안정적인(sound) 화폐라는 의미를 지닌다. 이더리움은 EIP-1559를 적용하여 프로토콜에 의해 산정되는 기본 가스비(BASEFEE)와 사용자의 팁을 가스비로 지불한다. 기본 가스비는 블록 생성자에게 돌아가는 것이 아니라 소각하게 되는데 이것으로 인해 인플레이션 억제 효과를 거둘 수 있다.  
이더리움은 신규 발행량보다 소각되는 이더가 더 많아서 실질적으로는 이더가 줄어들고 있다(최근에는 약간 증가하는 추세). 연간 1.76% 정도를 보이는 비트코인과 비교하면 이더리움은 -0.23%라는 통계가 있다.  
[ultrasound money](https://ultrasound.money/)  
EIP-1559 이전에는 채굴자들에게 다른 지불수단으로 수수료를 내고 트랜잭션을 처리할 수도 있었지만 이제는 기본 가스비가 항상 이더로 소각되어야 하므로 반드시 네이티브 토큰인 이더를 사용하도록 유도하는 효과도 있다(preventing economic abstraction).  

[Home](../README.md)